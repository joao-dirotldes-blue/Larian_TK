<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>Emissão de Bilhete</title>
    <link rel="stylesheet" href="styles.css" />
    <!-- Bibliotecas necessárias para captura e PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
      // Garante que html2canvas e jsPDF fiquem disponíveis globalmente
      window.html2canvas = window.html2canvas;
      window.jspdf = window.jspdf || {};
    </script>
    <!-- PDF-LIB via CDN -->
    <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
    <!-- App -->
    <script src="app.js" defer></script>
  </head>
  <body>
    <main class="container">
      <h1>Emissão de Bilhete</h1>
      <p class="subtitle">Revise o orçamento, preencha os dados e emita seu bilhete.</p>

      <div class="stepper">
        <div class="step-indicator" id="step1-dot">1</div>
        <div class="step-line"></div>
        <div class="step-indicator" id="step2-dot">2</div>
        <div class="step-line"></div>
        <div class="step-indicator" id="step3-dot">3</div>
        <div class="step-line"></div>
        <div class="step-indicator" id="step4-dot">4</div>
      </div>

      <!-- STEP 1: Orçamento (somente leitura) -->
      <section id="step1" class="card step">
        <h2>1) Orçamento</h2>

        <div class="quote-card" id="quoteCard">
          <div class="quote-header">
            <img src="logo.png" alt="Logo da agência" class="agency-logo" />
            <div class="q-route">
              <span class="chip" id="q-origin">—</span>
              <span class="arrow">→</span>
              <span class="chip" id="q-destination">—</span>
            </div>
            <div class="q-airline" id="q-airline">—</div>
            <div class="q-date" id="q-date">—</div>
            <div class="quote-expiry" id="quoteExpiry" aria-live="polite">
              <span class="clock" aria-hidden="true">⏳</span>
              <span class="expiry-label">Oferta expira em</span>
              <span id="expiryCountdown">—:—</span>
              <div class="expiry-progress">
                <div class="bar" id="expiryProgressBar"></div>
              </div>
            </div>
          </div>

          <div class="quote-body">
            <div class="timeline">
              <div class="timeline-item">
                <div class="time" id="q-depart">—</div>
                <div class="label">Partida</div>
              </div>
              <div class="timeline-sep">
                <div class="duration" id="q-duration">—</div>
              </div>
              <div class="timeline-item">
                <div class="time" id="q-arrive">—</div>
                <div class="label">Chegada</div>
              </div>
            </div>

            <div class="quote-meta">
              <div class="meta-row">
                <span class="meta-label">Escalas</span>
                <span class="meta-value" id="q-stops">—</span>
              </div>
              <div class="meta-row">
                <span class="meta-label">Bagagem</span>
                <span class="meta-value" id="q-baggage">—</span>
              </div>
            </div>

            <div class="quote-price">
              <div class="price-badge">
                <span class="price-label">Total</span>
                <span class="price-value" id="q-total">—</span>
              </div>
            </div>
          </div>

          <div class="info-box">
            <strong>Condições resumidas</strong>
            <p>
              Voos válidos apenas para as datas e horários reservados. Alterações voluntárias estão
              sujeitas às regras da companhia aérea e a eventuais diferenças tarifárias.
            </p>
          </div>

          <div class="quote-footer">
            <div class="meta-row">
              <span class="meta-label">Identificador da viagem</span>
              <span class="meta-value id-wrap">
                <span id="reservationCodePreview">—</span>
                <button id="copyReservaBtn" class="copy-btn" type="button" aria-label="Copiar identificador">Copiar</button>
              </span>
            </div>
          </div>
        </div>

        <input type="hidden" id="reservaId" name="reservaId" />
        <div class="actions">
          <button id="toStep2" class="primary" type="button">Preencher Passageiro</button>
        </div>
      </section>

      <!-- STEP 2: Dados do Passageiro -->
      <section id="step2" class="card step hidden">
        <h2>2) Passageiros</h2>
        <form id="passengerForm">
          <div class="grid">
            <div class="field">
              <label for="nomeCompleto">Nome Completo</label>
              <input id="nomeCompleto" name="nomeCompleto" type="text" placeholder="Nome completo" required />
            </div>

            <div class="field">
              <label for="cpf">CPF</label>
              <input id="cpf" name="cpf" type="text" inputmode="numeric" placeholder="000.000.000-00" required />
            </div>

            <div class="field">
              <label for="telefone">Telefone</label>
              <input id="telefone" name="telefone" type="tel" placeholder="(00) 00000-0000" />
            </div>

            <div class="field">
              <label for="email">E-mail</label>
              <input id="email" name="email" type="email" placeholder="email@exemplo.com" required />
            </div>
          </div>
        </form>
        <div class="actions">
          <button id="backTo1" class="secondary" type="button">Voltar</button>
          <button id="toStepPayment" class="primary" type="button">Ir para pagamento</button>
        </div>
      </section>

      <!-- STEP 3: Pagamento (Simulado) -->
      <section id="step3" class="card step hidden">
        <h2>3) Pagamento</h2>
        <p class="muted">Selecione o método de pagamento e confirme. Após a reserva, apresentaremos seus dados e você poderá baixar o PDF.</p>

        <div class="pay-summary">
          <div class="summary-row">
            <span class="label">Valor</span>
            <span id="amountDue" class="value">—</span>
          </div>
        </div>

        <div class="pay-methods">
          <label class="radio-card">
            <input type="radio" name="payMethod" value="pix" checked />
            <span>Pix</span>
          </label>
          <label class="radio-card">
            <input type="radio" name="payMethod" value="cartao" />
            <span>Cartão</span>
          </label>
        </div>

        <div class="actions">
          <button id="btnPay" class="primary" type="button">Confirmar Pagamento</button>
        </div>

        <div id="debugTools" class="card muted hidden" style="margin-top:12px; padding:12px;">
          <strong>Ferramentas de Debug</strong>
          <div class="grid">
            <div class="field field-full">
              <label for="debugIdentInput">IdentificacaoDaViagem</label>
              <input id="debugIdentInput" type="text" placeholder="Cole aqui o identificador (base64)" />
              <small class="muted">Use ?debug=1 na URL para exibir estas ferramentas automaticamente.</small>
            </div>
          </div>
          <div class="actions">
            <button id="btnApplyIdent" class="secondary" type="button">Aplicar no formulário</button>
            <button id="btnSaveIdent" class="secondary" type="button">Salvar como fallback (/identificacao)</button>
            <a id="linkOpenConfig" class="button-link" href="#" target="_blank" rel="noopener">Abrir /config</a>
            <a id="linkOpenDebug" class="button-link" href="#" target="_blank" rel="noopener">Abrir /debug/last-reserve</a>
          </div>
        </div>

        <div id="paymentStatus" class="status" role="status"></div>

        <div class="actions">
          <button id="backTo1" class="secondary" type="button">Voltar</button>
        </div>
      </section>

      <!-- STEP 4: Confirmação -->
      <section id="step4" class="card step hidden">
        <h2>4) Sua passagem</h2>

        <!-- Boarding Pass -->
        <div class="boarding-pass">
          <!-- Talão principal -->
          <div class="bp-main">
            <div class="bp-header">
              <img src="logo.png" alt="Logo da agência" class="bp-logo" />
              <span class="bp-title">Boarding Pass</span>
            </div>

            <div class="bp-route" id="bp-route">—</div>

            <div class="bp-grid">
              <div class="bp-item">
                <div class="bp-label">Companhia / Voo</div>
                <div class="bp-value" id="bp-airline">—</div>
              </div>
              <div class="bp-item">
                <div class="bp-label">Data</div>
                <div class="bp-value" id="bp-date">—</div>
              </div>
              <div class="bp-item">
                <div class="bp-label">Partida</div>
                <div class="bp-value" id="bp-depart">—</div>
              </div>
              <div class="bp-item">
                <div class="bp-label">Chegada</div>
                <div class="bp-value" id="bp-arrive">—</div>
              </div>
              <div class="bp-item">
                <div class="bp-label">Duração</div>
                <div class="bp-value" id="bp-duration">—</div>
              </div>
              <div class="bp-item">
                <div class="bp-label">Escalas</div>
                <div class="bp-value" id="bp-stops">—</div>
              </div>
              <div class="bp-item bp-full">
                <div class="bp-label">Bagagem</div>
                <div class="bp-value" id="bp-baggage">—</div>
              </div>
            </div>

            <div class="bp-footer">
              <div class="bp-passenger">
                <div class="bp-label">Passageiro</div>
                <div class="bp-value" id="bp-pax">—</div>
              </div>
              <div class="bp-total">
                <div class="bp-label">Total</div>
                <div class="bp-value" id="bp-total">—</div>
              </div>
            </div>
          </div>

          <!-- Linha de perfuração -->
          <div class="bp-perf" aria-hidden="true"></div>

          <!-- Talão destacável -->
          <div class="bp-stub">
            <div class="bp-stub-row">
              <span class="chip" id="bp-origin">—</span>
              <span class="arrow">→</span>
              <span class="chip" id="bp-destination">—</span>
            </div>
            <div class="bp-stub-row">
              <div class="bp-label">Identificador</div>
              <div class="bp-pnr-wrap">
                <span id="bp-pnr">—</span>
                <button id="bp-copyBtn" class="copy-btn" type="button" aria-label="Copiar identificador">Copiar</button>
              </div>
            </div>
            <div class="bp-barcode" id="bp-barcode" aria-hidden="true"></div>
          </div>
        </div>

        <div class="actions">
          <button id="btnDownloadPdf" class="primary" type="button">Baixar PDF</button>
        </div>
      </section>

      <div id="status" class="status" role="status" aria-live="polite"></div>

      <!-- Overlay de processamento (reserva + emissão) -->
      <div id="overlay" class="overlay-backdrop" aria-live="polite" aria-busy="true" hidden>
        <div class="overlay-card">
          <div class="plane" aria-hidden="true">✈️</div>
          <div class="overlay-text" id="overlayText">Processando…</div>
        </div>
      </div>
    </main>
  </body>
</html>
